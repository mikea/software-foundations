<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
<link href="coqdoc.css" rel="stylesheet" type="text/css"/>
<title>Imp: Simple Imperative Programs</title>
</head>

<script>
<!--
  function toggleDisplay(id)
  {
     var elt = document.getElementById(id);
     if (elt.style.display == 'none') {
       elt.style.display = 'block';
     } else {
       elt.style.display = 'none';
     }
  }
  function hideAll(cls)
  {
    var testClass = new RegExp("(^|s)" + cls + "(s|$)");
    var tag = tag || "*";
    var elements = document.getElementsByTagName("div");
    var current;
    var length = elements.length;
    for(var i=0; i<length; i++){
      current = elements[i];
      if(testClass.test(current.className)) {
        current.style.display = 'none';
      }
    }
  }
// --> 
</script>

<body onLoad="hideAll('proofscript')">
<body>

<div id="page">

<div id="header">
</div>

<div id="main">

<h1 class="libtitle">Imp<span class="subtitle">Simple Imperative Programs</span></h1>

<div class="code code-tight">
</div>

<div class="doc">

</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;$Date:&nbsp;2012-07-25&nbsp;16:43:16&nbsp;-0400&nbsp;(Wed,&nbsp;25&nbsp;Jul&nbsp;2012)&nbsp;$&nbsp;*)</span><br/>

<br/>
</div>

<div class="doc">
In this chapter, we begin a new direction that will
    continue for the rest of the course.  Up to now we've been mostly
    studying Coq itself, but from now on we'll mostly be using Coq to
    formalize other things.

<div class="paragraph"> </div>

    Our first case study is a <i>simple imperative programming language</i>
    called Imp.  Here is a familiar mathematical function written in
    Imp.

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;::=&nbsp;<span class="id" type="var">X</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;1;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">WHILE</span>&nbsp;<span class="id" type="var">not</span>&nbsp;(<span class="id" type="var">Z</span>&nbsp;=&nbsp;0)&nbsp;<span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span>&nbsp;::=&nbsp;<span class="id" type="var">Y</span>&nbsp;*&nbsp;<span class="id" type="var">Z</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span>&nbsp;::=&nbsp;<span class="id" type="var">Z</span>&nbsp;-&nbsp;1<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">END</span>
<div class="paragraph"> </div>

</div>

</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab271"></a><h3 class="section">Sflib</h3>

<div class="paragraph"> </div>

 A minor technical point: Instead of asking Coq to import our
    earlier definitions from chapter <span class="inlinecode"><span class="id" type="var">Logic</span></span>, we import a small library
    called <span class="inlinecode"><span class="id" type="var">Sflib.v</span></span>, containing just a few definitions and theorems
    from earlier chapters that we'll actually use in the rest of the
    course.  This change should be nearly invisible, since most of what's
    missing from Sflib has identical definitions in the Coq standard
    library.  The main reason for doing it is to tidy the global Coq
    environment so that, for example, it is easier to search for
    relevant theorems. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Require</span> <span class="id" type="keyword">Export</span> <span class="id" type="var">SfLib</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab272"></a><h1 class="section">Arithmetic and Boolean Expressions</h1>

<div class="paragraph"> </div>

 We'll present Imp in three parts: first a core language of
    <i>arithmetic and boolean expressions</i>, then an extension of these
    expressions with <i>variables</i>, and finally a language of <i>commands</i>
    including assignment, conditions, sequencing, and loops. 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab273"></a><h2 class="section">Syntax</h2>

</div>
<div class="code code-space">

<br/>
<span class="id" type="keyword">Module</span> <span class="id" type="var">AExp</span>.<br/>

<br/>
</div>

<div class="doc">
These two definitions specify the <i>abstract syntax</i> of
    arithmetic and boolean expressions. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">aexp</span> : <span class="id" type="keyword">Type</span> := <br/>
&nbsp;&nbsp;| <span class="id" type="var">ANum</span> : <span class="id" type="var">nat</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">APlus</span> : <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">AMinus</span> : <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">AMult</span> : <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span>.<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">bexp</span> : <span class="id" type="keyword">Type</span> := <br/>
&nbsp;&nbsp;| <span class="id" type="var">BTrue</span> : <span class="id" type="var">bexp</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BFalse</span> : <span class="id" type="var">bexp</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BEq</span> : <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">bexp</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BLe</span> : <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">bexp</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BNot</span> : <span class="id" type="var">bexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">bexp</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BAnd</span> : <span class="id" type="var">bexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">bexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">bexp</span>.<br/>

<br/>
</div>

<div class="doc">
In this chapter, we'll elide the translation from the
    concrete syntax that a programmer would actually write to these
    abstract syntax trees &mdash; the process that, for example, would
    translate the string <span class="inlinecode">"1+2*3"</span> to the AST <span class="inlinecode"><span class="id" type="var">APlus</span></span> <span class="inlinecode">(<span class="id" type="var">ANum</span></span>
    <span class="inlinecode">1)</span> <span class="inlinecode">(<span class="id" type="var">AMult</span></span> <span class="inlinecode">(<span class="id" type="var">ANum</span></span> <span class="inlinecode">2)</span> <span class="inlinecode">(<span class="id" type="var">ANum</span></span> <span class="inlinecode">3))</span>.  The optional chapter <span class="inlinecode"><span class="id" type="var">ImpParser</span></span>
    develops a simple implementation of a lexical analyzer and parser
    that can perform this translation.  You do <i>not</i> need to
    understand that file to understand this one, but if you haven't
    taken a course where these techniques are covered (e.g., a
    compilers course) you may want to skim it. 
<div class="paragraph"> </div>

 For comparison, here's a conventional BNF (Backus-Naur Form)
    grammar defining the same abstract syntax: 

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">aexp</span>&nbsp;::=&nbsp;<span class="id" type="var">nat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">aexp</span>&nbsp;'+'&nbsp;<span class="id" type="var">aexp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">aexp</span>&nbsp;'-'&nbsp;<span class="id" type="var">aexp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">aexp</span>&nbsp;'*'&nbsp;<span class="id" type="var">aexp</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">bexp</span>&nbsp;::=&nbsp;<span class="id" type="var">true</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">false</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">aexp</span>&nbsp;'='&nbsp;<span class="id" type="var">aexp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">aexp</span>&nbsp;'&lt;='&nbsp;<span class="id" type="var">aexp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;<span class="id" type="var">bexp</span>&nbsp;'<span class="id" type="var">and'</span>&nbsp;<span class="id" type="var">bexp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&nbsp;'<span class="id" type="var">not'</span>&nbsp;<span class="id" type="var">bexp</span>&nbsp;
<div class="paragraph"> </div>

</div>

<div class="paragraph"> </div>

 Compared to the Coq version above...

<div class="paragraph"> </div>

<ul class="doclist">
<li> The BNF is more informal &mdash; for example, it gives some
         suggestions about the surface syntax of expressions (like the
         fact that the addition operation is written <span class="inlinecode">+</span> and is an
         infix symbol) while leaving other aspects of lexical analysis
         and parsing (like the relative precedence of <span class="inlinecode">+</span>, <span class="inlinecode">-</span>, and
         <span class="inlinecode">*</span>) unspecified.  Some additional information &mdash; and human
         intelligence &mdash; would be required to turn this description
         into a formal definition (when implementing a compiler, for
         example).

<div class="paragraph"> </div>

         The Coq version consistently omits all this information and
         concentrates on the abstract syntax only.

<div class="paragraph"> </div>


</li>
<li> On the other hand, the BNF version is lighter and 
         easier to read.  Its informality makes it flexible, which is
         a huge advantage in situations like discussions at the
         blackboard, where conveying general ideas is more important
         than getting every detail nailed down precisely. 

<div class="paragraph"> </div>

         Indeed, there are dozens of BNF-like notations and people
         switch freely among them, usually without bothering to say which
         form of BNF they're using because there is no need to: a
         rough-and-ready informal understanding is all that's
         needed. 
</li>
</ul>

</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab274"></a><h2 class="section">Evaluation</h2>

<div class="paragraph"> </div>

 <i>Evaluating</i> an arithmetic expression produces a number. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">aeval</span> (<span class="id" type="var">e</span> : <span class="id" type="var">aexp</span>) : <span class="id" type="var">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">e</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">ANum</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">APlus</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span> =&gt; (<span class="id" type="var">aeval</span> <span class="id" type="var">a1</span>) + (<span class="id" type="var">aeval</span> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">AMinus</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>  =&gt; (<span class="id" type="var">aeval</span> <span class="id" type="var">a1</span>) - (<span class="id" type="var">aeval</span> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">AMult</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span> =&gt; (<span class="id" type="var">aeval</span> <span class="id" type="var">a1</span>) * (<span class="id" type="var">aeval</span> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">test_aeval1</span>: <br/>
&nbsp;&nbsp;<span class="id" type="var">aeval</span> (<span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 2) (<span class="id" type="var">ANum</span> 2)) = 4.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Similarly, evaluating a boolean expression yields a boolean. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">beval</span> (<span class="id" type="var">e</span> : <span class="id" type="var">bexp</span>) : <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">e</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| <span class="id" type="var">BTrue</span>       =&gt; <span class="id" type="var">true</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BFalse</span>      =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BEq</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>   =&gt; <span class="id" type="var">beq_nat</span> (<span class="id" type="var">aeval</span> <span class="id" type="var">a1</span>) (<span class="id" type="var">aeval</span> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">BLe</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>   =&gt; <span class="id" type="var">ble_nat</span> (<span class="id" type="var">aeval</span> <span class="id" type="var">a1</span>) (<span class="id" type="var">aeval</span> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">BNot</span> <span class="id" type="var">b1</span>     =&gt; <span class="id" type="var">negb</span> (<span class="id" type="var">beval</span> <span class="id" type="var">b1</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">BAnd</span> <span class="id" type="var">b1</span> <span class="id" type="var">b2</span>  =&gt; <span class="id" type="var">andb</span> (<span class="id" type="var">beval</span> <span class="id" type="var">b1</span>) (<span class="id" type="var">beval</span> <span class="id" type="var">b2</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab275"></a><h2 class="section">Optimization</h2>

<div class="paragraph"> </div>

 We haven't defined very much yet, but we can already get
    some mileage out of the definitions.  Suppose we define a function
    that takes an arithmetic expression and slightly simplifies it,
    changing every occurrence of <span class="inlinecode">0+<span class="id" type="var">e</span></span> (i.e., <span class="inlinecode">(<span class="id" type="var">APlus</span></span> <span class="inlinecode">(<span class="id" type="var">ANum</span></span> <span class="inlinecode">0)</span> <span class="inlinecode"><span class="id" type="var">e</span></span>)
    into just <span class="inlinecode"><span class="id" type="var">e</span></span>. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">optimize_0plus</span> (<span class="id" type="var">e</span>:<span class="id" type="var">aexp</span>) : <span class="id" type="var">aexp</span> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">e</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">ANum</span> <span class="id" type="var">n</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ANum</span> <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 0) <span class="id" type="var">e2</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">optimize_0plus</span> <span class="id" type="var">e2</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">APlus</span> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">APlus</span> (<span class="id" type="var">optimize_0plus</span> <span class="id" type="var">e1</span>) (<span class="id" type="var">optimize_0plus</span> <span class="id" type="var">e2</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">AMinus</span> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">AMinus</span> (<span class="id" type="var">optimize_0plus</span> <span class="id" type="var">e1</span>) (<span class="id" type="var">optimize_0plus</span> <span class="id" type="var">e2</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">AMult</span> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">AMult</span> (<span class="id" type="var">optimize_0plus</span> <span class="id" type="var">e1</span>) (<span class="id" type="var">optimize_0plus</span> <span class="id" type="var">e2</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
To make sure our optimization is doing the right thing we
    can test it on some examples and see if the output looks OK. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">test_optimize_0plus</span>: <br/>
&nbsp;&nbsp;<span class="id" type="var">optimize_0plus</span> (<span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 2) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 0) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 0) (<span class="id" type="var">ANum</span> 1)))) <br/>
&nbsp;&nbsp;= <span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 2) (<span class="id" type="var">ANum</span> 1).<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
But if we want to be sure the optimization is correct &mdash;
    i.e., that evaluating an optimized expression gives the same
    result as the original &mdash; we should prove it. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">optimize_0plus_sound</span>: <span style="font-family: arial;">&forall;</span><span class="id" type="var">e</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">aeval</span> (<span class="id" type="var">optimize_0plus</span> <span class="id" type="var">e</span>) = <span class="id" type="var">aeval</span> <span class="id" type="var">e</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">e</span>. <span class="id" type="tactic">induction</span> <span class="id" type="var">e</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "ANum". <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "APlus". <span class="id" type="tactic">destruct</span> <span class="id" type="var">e1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "e1 = ANum n". <span class="id" type="tactic">destruct</span> <span class="id" type="var">n</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "n = 0". <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">apply</span> <span class="id" type="var">IHe2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SSCase</span> "n &lt;&gt; 0". <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "e1 = APlus e1_1 e1_2".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">IHe1</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "e1 = AMinus e1_1 e1_2".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">IHe1</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "e1 = AMult e1_1 e1_2".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">IHe1</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "AMinus".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "AMult".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab276"></a><h1 class="section">Coq Automation</h1>

<div class="paragraph"> </div>

 The repetition in this last proof is starting to be a little
    annoying.  If either the language of arithmetic expressions or the
    optimization being proved sound were significantly more complex,
    it would begin to be a real problem.

<div class="paragraph"> </div>

    So far, we've been doing all our proofs using just a small handful
    of Coq's tactics and completely ignoring its powerful facilities
    for constructing parts of proofs automatically.  This section
    introduces some of these facilities, and we will see more over the
    next several chapters.  Getting used to them will take some
    energy &mdash; Coq's automation is a power tool &mdash; but it will allow us
    to scale up our efforts to more complex definitions and more
    interesting properties without becoming overwhelmed by boring,
    repetitive, low-level details. 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab277"></a><h2 class="section">Tacticals</h2>

<div class="paragraph"> </div>

 <i>Tacticals</i> is Coq's term for tactics that take other tactics as
    arguments &mdash; "higher-order tactics," if you will.  
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab278"></a><h3 class="section">The <span class="inlinecode"><span class="id" type="tactic">repeat</span></span> Tactical</h3>

<div class="paragraph"> </div>

 The <span class="inlinecode"><span class="id" type="tactic">repeat</span></span> tactical takes another tactic and keeps applying
    this tactic until the tactic fails. Here is an example showing
    that <span class="inlinecode">100</span> is even using repeat. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">ev100</span> : <span class="id" type="var">ev</span> 100.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">repeat</span> (<span class="id" type="tactic">apply</span> <span class="id" type="var">ev_SS</span>). <span class="comment">(*&nbsp;applies&nbsp;ev_SS&nbsp;50&nbsp;times,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;then&nbsp;<span class="inlinecode"><span class="id" type="tactic">apply</span></span> <span class="inlinecode"><span class="id" type="var">ev_SS</span></span>&nbsp;fails&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">ev_0</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
<span class="comment">(*&nbsp;Print&nbsp;ev100.&nbsp;*)</span><br/>

<br/>
</div>

<div class="doc">
The <span class="inlinecode"><span class="id" type="tactic">repeat</span></span> <span class="inlinecode"><span class="id" type="var">T</span></span> tactic never fails; if the tactic <span class="inlinecode"><span class="id" type="var">T</span></span> doesn't apply
    to the original goal, then repeat still succeeds without changing
    the original goal (it repeats zero times). 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">ev100'</span> : <span class="id" type="var">ev</span> 100.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">repeat</span> (<span class="id" type="tactic">apply</span> <span class="id" type="var">ev_0</span>). <span class="comment">(*&nbsp;doesn't&nbsp;fail,&nbsp;applies&nbsp;ev_0&nbsp;zero&nbsp;times&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">repeat</span> (<span class="id" type="tactic">apply</span> <span class="id" type="var">ev_SS</span>). <span class="id" type="tactic">apply</span> <span class="id" type="var">ev_0</span>. <span class="comment">(*&nbsp;we&nbsp;can&nbsp;continue&nbsp;the&nbsp;proof&nbsp;*)</span><br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
The <span class="inlinecode"><span class="id" type="tactic">repeat</span></span> <span class="inlinecode"><span class="id" type="var">T</span></span> tactic does not have any bound on the number of
    times it applies <span class="inlinecode"><span class="id" type="var">T</span></span>. If <span class="inlinecode"><span class="id" type="var">T</span></span> is a tactic that always succeeds then
    repeat <span class="inlinecode"><span class="id" type="var">T</span></span> will loop forever (e.g. <span class="inlinecode"><span class="id" type="tactic">repeat</span></span> <span class="inlinecode"><span class="id" type="tactic">simpl</span></span> loops forever
    since <span class="inlinecode"><span class="id" type="tactic">simpl</span></span> always succeeds). While Coq's term language is
    guaranteed to terminate, Coq's tactic language is not. 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab279"></a><h3 class="section">The <span class="inlinecode"><span class="id" type="tactic">try</span></span> Tactical</h3>

<div class="paragraph"> </div>

 A similar tactical is <span class="inlinecode"><span class="id" type="tactic">try</span></span>: If <span class="inlinecode"><span class="id" type="var">T</span></span> is a tactic, then <span class="inlinecode"><span class="id" type="tactic">try</span></span> <span class="inlinecode"><span class="id" type="var">T</span></span>
    is a tactic that is just like <span class="inlinecode"><span class="id" type="var">T</span></span> except that, if <span class="inlinecode"><span class="id" type="var">T</span></span> fails, 
    <span class="inlinecode"><span class="id" type="tactic">try</span></span> <span class="inlinecode"><span class="id" type="var">T</span></span> <i>successfully</i> does nothing at all (instead of failing). 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">silly1</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">ae</span>, <span class="id" type="var">aeval</span> <span class="id" type="var">ae</span> = <span class="id" type="var">aeval</span> <span class="id" type="var">ae</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">try</span> <span class="id" type="tactic">reflexivity</span>. <span class="comment">(*&nbsp;this&nbsp;just&nbsp;does&nbsp;<span class="inlinecode"><span class="id" type="tactic">reflexivity</span></span>&nbsp;*)</span> <span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">silly2</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">P</span> : <span class="id" type="keyword">Prop</span>), <span class="id" type="var">P</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">P</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">P</span> <span class="id" type="var">HP</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">reflexivity</span>. <span class="comment">(*&nbsp;just&nbsp;<span class="inlinecode"><span class="id" type="tactic">reflexivity</span></span>&nbsp;would&nbsp;have&nbsp;failed&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">HP</span>. <span class="comment">(*&nbsp;we&nbsp;can&nbsp;still&nbsp;finish&nbsp;the&nbsp;proof&nbsp;in&nbsp;some&nbsp;other&nbsp;way&nbsp;*)</span><br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Using <span class="inlinecode"><span class="id" type="tactic">try</span></span> in a completely manual proof is a bit silly, but we'll
    see below that <span class="inlinecode"><span class="id" type="tactic">try</span></span> is very useful for doing automated proofs
    in conjunction with the <span class="inlinecode">;</span> tactical. 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab280"></a><h3 class="section">The <span class="inlinecode">;</span> Tactical (Simple Form)</h3>

<div class="paragraph"> </div>

 In its simplest and most commonly used form, the <span class="inlinecode">;</span> tactical
    takes 2 tactics as argument: <span class="inlinecode"><span class="id" type="var">T</span>;<span class="id" type="var">T'</span></span> first performs the tactic <span class="inlinecode"><span class="id" type="var">T</span></span>
    and then performs the tactic <span class="inlinecode"><span class="id" type="var">T'</span></span> on <i>each subgoal</i> generated by
    <span class="inlinecode"><span class="id" type="var">T</span></span>. 
<div class="paragraph"> </div>

 For example, consider the following trivial lemma: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">foo</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">n</span>, <span class="id" type="var">ble_nat</span> 0 <span class="id" type="var">n</span> = <span class="id" type="var">true</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">n</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Leaves&nbsp;two&nbsp;subgoals...&nbsp;&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Case</span> "n=0". <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Case</span> "n=Sn'". <span class="id" type="tactic">simpl</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;...&nbsp;which&nbsp;are&nbsp;discharged&nbsp;similarly&nbsp;*)</span><br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
We can simplify this proof using the <span class="inlinecode">;</span> tactical: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Lemma</span> <span class="id" type="var">foo'</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">n</span>, <span class="id" type="var">ble_nat</span> 0 <span class="id" type="var">n</span> = <span class="id" type="var">true</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">n</span>; <span class="comment">(*&nbsp;<span class="inlinecode"><span class="id" type="tactic">destruct</span></span>&nbsp;the&nbsp;current&nbsp;goal&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="comment">(*&nbsp;then&nbsp;<span class="inlinecode"><span class="id" type="tactic">simpl</span></span>&nbsp;each&nbsp;resulting&nbsp;subgoal&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>. <span class="comment">(*&nbsp;then&nbsp;do&nbsp;<span class="inlinecode"><span class="id" type="tactic">reflexivity</span></span>&nbsp;on&nbsp;each&nbsp;resulting&nbsp;subgoal&nbsp;*)</span><br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Using <span class="inlinecode"><span class="id" type="tactic">try</span></span> and <span class="inlinecode">;</span> together, we can get rid of the repetition in
    the proof that was bothering us a little while ago. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">optimize_0plus_sound'</span>: <span style="font-family: arial;">&forall;</span><span class="id" type="var">e</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">aeval</span> (<span class="id" type="var">optimize_0plus</span> <span class="id" type="var">e</span>) = <span class="id" type="var">aeval</span> <span class="id" type="var">e</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">e</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">e</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Most&nbsp;cases&nbsp;follow&nbsp;directly&nbsp;by&nbsp;the&nbsp;IH&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>; <span class="id" type="tactic">reflexivity</span>).<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;remaining&nbsp;cases&nbsp;--&nbsp;ANum&nbsp;and&nbsp;APlus&nbsp;--&nbsp;are&nbsp;more<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;interesting...&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "ANum". <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "APlus".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">e1</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Again,&nbsp;most&nbsp;cases&nbsp;follow&nbsp;directly&nbsp;by&nbsp;the&nbsp;IH&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">IHe1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>; <span class="id" type="tactic">reflexivity</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;interesting&nbsp;case,&nbsp;on&nbsp;which&nbsp;the&nbsp;<span class="inlinecode"><span class="id" type="tactic">try</span>...</span>&nbsp;does&nbsp;nothing,&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;when&nbsp;<span class="inlinecode"><span class="id" type="var">e1</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">ANum</span></span> <span class="inlinecode"><span class="id" type="var">n</span></span>.&nbsp;In&nbsp;this&nbsp;case,&nbsp;we&nbsp;have&nbsp;to&nbsp;destruct&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="inlinecode"><span class="id" type="var">n</span></span>&nbsp;(to&nbsp;see&nbsp;whether&nbsp;the&nbsp;optimization&nbsp;applies)&nbsp;and&nbsp;rewrite&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;the&nbsp;induction&nbsp;hypothesis.&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "e1 = ANum n". <span class="id" type="tactic">destruct</span> <span class="id" type="var">n</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>; <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
This proof can still be improved: the first case (for <span class="inlinecode"><span class="id" type="var">e</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">ANum</span></span>
    <span class="inlinecode"><span class="id" type="var">n</span></span>) is very trivial &mdash; even more trivial than the cases that we
    said simply followed from the IH &mdash; yet we have chosen to write it
    out in full.  It would be better and clearer to drop it and just
    say, at the top, "Most cases are either immediate or direct from
    the IH.  The only interesting case is the one for <span class="inlinecode"><span class="id" type="var">APlus</span></span>..."  We
    can make the same improvement in our formal proof too.  Here's how
    it looks: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">optimize_0plus_sound''</span>: <span style="font-family: arial;">&forall;</span><span class="id" type="var">e</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">aeval</span> (<span class="id" type="var">optimize_0plus</span> <span class="id" type="var">e</span>) = <span class="id" type="var">aeval</span> <span class="id" type="var">e</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">e</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">induction</span> <span class="id" type="var">e</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Most&nbsp;cases&nbsp;follow&nbsp;directly&nbsp;by&nbsp;the&nbsp;IH&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>; <span class="id" type="tactic">reflexivity</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;...&nbsp;or&nbsp;are&nbsp;immediate&nbsp;by&nbsp;definition&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;interesting&nbsp;case&nbsp;is&nbsp;when&nbsp;e&nbsp;=&nbsp;APlus&nbsp;e1&nbsp;e2.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "APlus".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">destruct</span> <span class="id" type="var">e1</span>; <span class="id" type="tactic">try</span> (<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">IHe1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>; <span class="id" type="tactic">reflexivity</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "e1 = ANum n". <span class="id" type="tactic">destruct</span> <span class="id" type="var">n</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>; <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab281"></a><h3 class="section">The <span class="inlinecode">;</span> Tactical (General Form)</h3>

<div class="paragraph"> </div>

 The <span class="inlinecode">;</span> tactical has a more general than the simple <span class="inlinecode"><span class="id" type="var">T</span>;<span class="id" type="var">T'</span></span> we've
    seen above, and which is sometimes also useful.
    If <span class="inlinecode"><span class="id" type="var">T</span></span>, <span class="inlinecode"><span class="id" type="var">T1</span></span>, ..., <span class="inlinecode"><span class="id" type="var">Tn</span></span> are tactics, then

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">T</span>;&nbsp;[<span class="id" type="var">T1</span>&nbsp;|&nbsp;<span class="id" type="var">T2</span>&nbsp;|&nbsp;... |&nbsp;<span class="id" type="var">Tn</span>]&nbsp;
<div class="paragraph"> </div>

</div>
   is a tactic that first performs <span class="inlinecode"><span class="id" type="var">T</span></span> and then performs <span class="inlinecode"><span class="id" type="var">T1</span></span> on the
   first subgoal generated by <span class="inlinecode"><span class="id" type="var">T</span></span>, performs <span class="inlinecode"><span class="id" type="var">T2</span></span> on the second
   subgoal, etc.

<div class="paragraph"> </div>

   So <span class="inlinecode"><span class="id" type="var">T</span>;<span class="id" type="var">T'</span></span> is just special notation for the case when all of the
   <span class="inlinecode"><span class="id" type="var">Ti</span></span>'s are the same tactic; i.e. <span class="inlinecode"><span class="id" type="var">T</span>;<span class="id" type="var">T'</span></span> is just a shorthand for:

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">T</span>;&nbsp;[<span class="id" type="var">T'</span>&nbsp;|&nbsp;<span class="id" type="var">T'</span>&nbsp;|&nbsp;... |&nbsp;<span class="id" type="var">T'</span>]&nbsp;
<div class="paragraph"> </div>

</div>
  The form <span class="inlinecode"><span class="id" type="var">T</span>;<span class="id" type="var">T'</span></span> is used most often in practice. 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab282"></a><h2 class="section">Defining New Tactic Notations</h2>

<div class="paragraph"> </div>

 Coq also provides several ways of "programming" tactic scripts. 

<div class="paragraph"> </div>

<ul class="doclist">
<li> The <span class="inlinecode"><span class="id" type="keyword">Tactic</span></span> <span class="inlinecode"><span class="id" type="keyword">Notation</span></span> idiom illustrated below gives a handy
        way to define "shorthand tactics" that bundle several tactics
        into a single command.

<div class="paragraph"> </div>


</li>
<li> For more sophisticated programming, Coq offers a small
        built-in programming language called <span class="inlinecode"><span class="id" type="keyword">Ltac</span></span> with primitives
        that can examine and modify the proof state.  The details are
        a bit too complicated to get into here (and it is generally
        agreed that <span class="inlinecode"><span class="id" type="keyword">Ltac</span></span> is not the most beautiful part of Coq's
        design!), but they can be found in the reference manual, and
        there are many examples of <span class="inlinecode"><span class="id" type="keyword">Ltac</span></span> definitions in the Coq
        standard library that you can use as examples.

<div class="paragraph"> </div>


</li>
<li> There is also an OCaml API, which can be used to build tactics
        that access Coq's internal structures at a lower level, but
        this is seldom worth the trouble for ordinary Coq users.

</li>
</ul>

<div class="paragraph"> </div>

The <span class="inlinecode"><span class="id" type="keyword">Tactic</span></span> <span class="inlinecode"><span class="id" type="keyword">Notation</span></span> mechanism is the easiest to come to grips with,
and it offers plenty of power for many purposes.  Here's an example. 

</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Tactic Notation</span> "simpl_and_try" <span class="id" type="var">tactic</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>;<br/>
&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="var">c</span>.<br/>

<br/>
</div>

<div class="doc">
This defines a new tactical called <span class="inlinecode"><span class="id" type="var">simpl_and_try</span></span> which
    takes one tactic <span class="inlinecode"><span class="id" type="var">c</span></span> as an argument, and is defined to be
    equivalent to the tactic <span class="inlinecode"><span class="id" type="tactic">simpl</span>;</span> <span class="inlinecode"><span class="id" type="tactic">try</span></span> <span class="inlinecode"><span class="id" type="var">c</span></span>.  For example, writing
    "<span class="inlinecode"><span class="id" type="var">simpl_and_try</span></span> <span class="inlinecode"><span class="id" type="tactic">reflexivity</span>.</span>" in a proof would be the same as
    writing "<span class="inlinecode"><span class="id" type="tactic">simpl</span>;</span> <span class="inlinecode"><span class="id" type="tactic">try</span></span> <span class="inlinecode"><span class="id" type="tactic">reflexivity</span>.</span>" 
<div class="paragraph"> </div>

 The next subsection gives a more sophisticated use of this
    feature... 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab283"></a><h3 class="section">Bulletproofing Case Analyses</h3>

<div class="paragraph"> </div>

 Being able to deal with most of the cases of an <span class="inlinecode"><span class="id" type="tactic">induction</span></span>
    or <span class="inlinecode"><span class="id" type="tactic">destruct</span></span> all at the same time is very convenient, but it can
    also be a little confusing.  One problem that often comes up is
    that <i>maintaining</i> proofs written in this style can be difficult.
    For example, suppose that, later, we extended the definition of
    <span class="inlinecode"><span class="id" type="var">aexp</span></span> with another constructor that also required a special
    argument.  The above proof might break because Coq generated the
    subgoals for this constructor before the one for <span class="inlinecode"><span class="id" type="var">APlus</span></span>, so that,
    at the point when we start working on the <span class="inlinecode"><span class="id" type="var">APlus</span></span> case, Coq is
    actually expecting the argument for a completely different
    constructor.  What we'd like is to get a sensible error message
    saying "I was expecting the <span class="inlinecode"><span class="id" type="var">AFoo</span></span> case at this point, but the
    proof script is talking about <span class="inlinecode"><span class="id" type="var">APlus</span></span>."  Here's a nice trick (due
    to Aaron Bohannon) that smoothly achieves this. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Tactic Notation</span> "aexp_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "ANum" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "APlus"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "AMinus" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "AMult" ].<br/>

<br/>
</div>

<div class="doc">
(<span class="inlinecode"><span class="id" type="var">Case_aux</span></span> implements the common functionality of <span class="inlinecode"><span class="id" type="var">Case</span></span>,
    <span class="inlinecode"><span class="id" type="var">SCase</span></span>, <span class="inlinecode"><span class="id" type="var">SSCase</span></span>, etc.  For example, <span class="inlinecode"><span class="id" type="var">Case</span></span> <span class="inlinecode">"<span class="id" type="var">foo</span>"</span> is defined as
    <span class="inlinecode"><span class="id" type="var">Case_aux</span></span> <span class="inlinecode"><span class="id" type="var">Case</span></span> <span class="inlinecode">"<span class="id" type="var">foo</span>".)</span> <span class="inlinecode"></span>
<div class="paragraph"> </div>

 For example, if <span class="inlinecode"><span class="id" type="var">e</span></span> is a variable of type <span class="inlinecode"><span class="id" type="var">aexp</span></span>, then doing

<div class="paragraph"> </div>

<div class="code code-tight">
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">aexp_cases</span>&nbsp;(<span class="id" type="tactic">induction</span>&nbsp;<span class="id" type="var">e</span>)&nbsp;<span class="id" type="var">Case</span>
<div class="paragraph"> </div>

</div>
    will perform an induction on <span class="inlinecode"><span class="id" type="var">e</span></span> (the same as if we had just typed
    <span class="inlinecode"><span class="id" type="tactic">induction</span></span> <span class="inlinecode"><span class="id" type="var">e</span></span>) and <i>also</i> add a <span class="inlinecode"><span class="id" type="var">Case</span></span> tag to each subgoal
    generated by the <span class="inlinecode"><span class="id" type="tactic">induction</span></span>, labeling which constructor it comes
    from.  For example, here is yet another proof of
    <span class="inlinecode"><span class="id" type="var">optimize_0plus_sound</span></span>, using <span class="inlinecode"><span class="id" type="var">aexp_cases</span></span>: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">optimize_0plus_sound'''</span>: <span style="font-family: arial;">&forall;</span><span class="id" type="var">e</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">aeval</span> (<span class="id" type="var">optimize_0plus</span> <span class="id" type="var">e</span>) = <span class="id" type="var">aeval</span> <span class="id" type="var">e</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">e</span>.<br/>
&nbsp;&nbsp;<span class="id" type="var">aexp_cases</span> (<span class="id" type="tactic">induction</span> <span class="id" type="var">e</span>) <span class="id" type="var">Case</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>; <span class="id" type="tactic">reflexivity</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;At&nbsp;this&nbsp;point,&nbsp;there&nbsp;is&nbsp;already&nbsp;an&nbsp;<span class="inlinecode">"<span class="id" type="var">APlus</span>"</span>&nbsp;case&nbsp;name<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in&nbsp;the&nbsp;context.&nbsp;&nbsp;The&nbsp;<span class="inlinecode"><span class="id" type="var">Case</span></span> <span class="inlinecode">"<span class="id" type="var">APlus</span>"</span>&nbsp;here&nbsp;in&nbsp;the&nbsp;proof&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text&nbsp;has&nbsp;the&nbsp;effect&nbsp;of&nbsp;a&nbsp;sanity&nbsp;check:&nbsp;if&nbsp;the&nbsp;"Case"&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;in&nbsp;the&nbsp;context&nbsp;is&nbsp;anything&nbsp;_other_&nbsp;than&nbsp;<span class="inlinecode">"<span class="id" type="var">APlus</span>"</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(for&nbsp;example,&nbsp;because&nbsp;we&nbsp;added&nbsp;a&nbsp;clause&nbsp;to&nbsp;the&nbsp;definition<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;of&nbsp;<span class="inlinecode"><span class="id" type="var">aexp</span></span>&nbsp;and&nbsp;forgot&nbsp;to&nbsp;change&nbsp;the&nbsp;proof)&nbsp;we'll&nbsp;get&nbsp;a&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;helpful&nbsp;error&nbsp;at&nbsp;this&nbsp;point&nbsp;telling&nbsp;us&nbsp;that&nbsp;this&nbsp;is&nbsp;now<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;wrong&nbsp;case.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="var">Case</span> "APlus".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">aexp_cases</span> (<span class="id" type="tactic">destruct</span> <span class="id" type="var">e1</span>) <span class="id" type="var">SCase</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">try</span> (<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">simpl</span> <span class="id" type="keyword">in</span> <span class="id" type="var">IHe1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe1</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>; <span class="id" type="tactic">reflexivity</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "ANum". <span class="id" type="tactic">destruct</span> <span class="id" type="var">n</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHe2</span>; <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab284"></a><h4 class="section">Exercise: 3 stars (optimize_0plus_b)</h4>
 Since the <span class="inlinecode"><span class="id" type="var">optimize_0plus</span></span> tranformation doesn't change the value
    of <span class="inlinecode"><span class="id" type="var">aexp</span></span>s, we should be able to apply it to all the <span class="inlinecode"><span class="id" type="var">aexp</span></span>s that
    appear in a <span class="inlinecode"><span class="id" type="var">bexp</span></span> without changing the <span class="inlinecode"><span class="id" type="var">bexp</span></span>'s value.  Write a
    function which performs that transformation on <span class="inlinecode"><span class="id" type="var">bexp</span></span>s, and prove
    it is sound.  Use the tacticals we've just seen to make the proof
    as elegant as possible. 
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab285"></a><h4 class="section">Exercise: 4 stars, optional (optimizer)</h4>
 <i>Design exercise</i>: The optimization implemented by our
    <span class="inlinecode"><span class="id" type="var">optimize_0plus</span></span> function is only one of many imaginable
    optimizations on arithmetic and boolean expressions.  Write a more
    sophisticated optimizer and prove it correct.

<div class="paragraph"> </div>

<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
 <font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab286"></a><h2 class="section">The <span class="inlinecode"><span class="id" type="tactic">omega</span></span> Tactic</h2>

<div class="paragraph"> </div>

 The <span class="inlinecode"><span class="id" type="tactic">omega</span></span> tactic implements a decision procedure for a subset of
    first-order logic called <i>Presburger arithmetic</i>.  It is based on
    the Omega algorithm invented in 1992 by William Pugh.

<div class="paragraph"> </div>

    If the goal is a universally quantified formula made out of

<div class="paragraph"> </div>

<ul class="doclist">
<li> numeric constants, addition (<span class="inlinecode">+</span> and <span class="inlinecode"><span class="id" type="var">S</span></span>), subtraction (<span class="inlinecode">-</span>
        and <span class="inlinecode"><span class="id" type="var">pred</span></span>), and multiplication by constants (this is what
        makes it Presburger arithmetic), 

<div class="paragraph"> </div>


</li>
<li> equality (<span class="inlinecode">=</span> and <span class="inlinecode">&lt;&gt;</span>) and inequality (<span class="inlinecode">&lt;=</span>), and

<div class="paragraph"> </div>


</li>
<li> the logical connectives <span class="inlinecode"><span style="font-family: arial;">&and;</span></span>, <span class="inlinecode"><span style="font-family: arial;">&or;</span></span>, <span class="inlinecode">~</span>, and <span class="inlinecode"><span style="font-family: arial;">&rarr;</span></span>,

</li>
</ul>

<div class="paragraph"> </div>

    then invoking <span class="inlinecode"><span class="id" type="tactic">omega</span></span> will either solve the goal or tell you that
    it is actually false. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">silly_presburger_example</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">m</span> <span class="id" type="var">n</span> <span class="id" type="var">o</span> <span class="id" type="var">p</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">m</span> + <span class="id" type="var">n</span> &lt;= <span class="id" type="var">n</span> + <span class="id" type="var">o</span> <span style="font-family: arial;">&and;</span> <span class="id" type="var">o</span> + 3 = <span class="id" type="var">p</span> + 3 <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;<span class="id" type="var">m</span> &lt;= <span class="id" type="var">p</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" type="tactic">intros</span>. <span class="id" type="tactic">omega</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
Andrew Appel calls this the "Santa Claus tactic."  We'll see
    examples of its use below. 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab287"></a><h2 class="section">A Few More Handy Tactics</h2>

<div class="paragraph"> </div>

 Finally, here are some miscellaneous tactics that you may find
    convenient.

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" type="tactic">clear</span></span> <span class="inlinecode"><span class="id" type="var">H</span></span>: Delete hypothesis <span class="inlinecode"><span class="id" type="var">H</span></span> from the context.

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span class="id" type="tactic">subst</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span>: Find an assumption <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">e</span></span> or <span class="inlinecode"><span class="id" type="var">e</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">x</span></span> in the
       context, replace <span class="inlinecode"><span class="id" type="var">x</span></span> with <span class="inlinecode"><span class="id" type="var">e</span></span> throughout the context and
       current goal, and clear the assumption.

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span class="id" type="tactic">subst</span></span>: Substitute away <i>all</i> assumptions of the form <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">e</span></span>
       or <span class="inlinecode"><span class="id" type="var">e</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" type="var">x</span></span>.

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span class="id" type="tactic">rename</span>...</span> <span class="inlinecode"><span class="id" type="var">into</span>...</span>: Change the name of a hypothesis in the
       proof context.  For example, if the context includes a variable
       named <span class="inlinecode"><span class="id" type="var">x</span></span>, then <span class="inlinecode"><span class="id" type="tactic">rename</span></span> <span class="inlinecode"><span class="id" type="var">x</span></span> <span class="inlinecode"><span class="id" type="var">into</span></span> <span class="inlinecode"><span class="id" type="var">y</span></span> will change all occurrences
       of <span class="inlinecode"><span class="id" type="var">x</span></span> to <span class="inlinecode"><span class="id" type="var">y</span></span>.

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span class="id" type="tactic">assumption</span></span>: Try to find a hypothesis <span class="inlinecode"><span class="id" type="var">H</span></span> in the context that
       exactly matches the goal; if one is found, behave just like
       <span class="inlinecode"><span class="id" type="tactic">apply</span></span> <span class="inlinecode"><span class="id" type="var">H</span></span>.

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span class="id" type="var">contradiction</span></span>: Try to find a hypothesis <span class="inlinecode"><span class="id" type="var">H</span></span> in the current
       context that is logically equivalent to <span class="inlinecode"><span class="id" type="var">False</span></span>.  If one is
       found, solve the goal.

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span class="id" type="var">constructor</span></span>: Try to find a constructor <span class="inlinecode"><span class="id" type="var">c</span></span> (from some
       <span class="inlinecode"><span class="id" type="keyword">Inductive</span></span> definition in the current environment) that can be
       applied to solve the current goal.  If one is found, behave
       like <span class="inlinecode"><span class="id" type="tactic">apply</span></span> <span class="inlinecode"><span class="id" type="var">c</span></span>.

</li>
</ul>

<div class="paragraph"> </div>

    We'll see many examples of these in the proofs below. 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab288"></a><h1 class="section">Evaluation as a Relation</h1>

</div>
<div class="code code-space">

<br/>
<span class="id" type="keyword">Reserved Notation</span> "e '<span style="font-family: arial;">&dArr;</span>' n" (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 50, <span class="id" type="var">left</span> <span class="id" type="var">associativity</span>).<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">aevalR</span> : <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">nat</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">E_ANum</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">n</span>:<span class="id" type="var">nat</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">ANum</span> <span class="id" type="var">n</span>) <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_APlus</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">e1</span> <span class="id" type="var">e2</span>: <span class="id" type="var">aexp</span>) (<span class="id" type="var">n1</span> <span class="id" type="var">n2</span> : <span class="id" type="var">nat</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">e1</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">n1</span>) <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">e2</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">n2</span>) <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">APlus</span> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span>) <span style="font-family: arial;">&dArr;</span> (<span class="id" type="var">n1</span> + <span class="id" type="var">n2</span>) <br/>
&nbsp;&nbsp;| <span class="id" type="var">E_AMinus</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">e1</span> <span class="id" type="var">e2</span>: <span class="id" type="var">aexp</span>) (<span class="id" type="var">n1</span> <span class="id" type="var">n2</span> : <span class="id" type="var">nat</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">e1</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">n1</span>) <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">e2</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">n2</span>) <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">AMinus</span> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span>) <span style="font-family: arial;">&dArr;</span> (<span class="id" type="var">n1</span> - <span class="id" type="var">n2</span>) <br/>
&nbsp;&nbsp;| <span class="id" type="var">E_AMult</span> :  <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">e1</span> <span class="id" type="var">e2</span>: <span class="id" type="var">aexp</span>) (<span class="id" type="var">n1</span> <span class="id" type="var">n2</span> : <span class="id" type="var">nat</span>), <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">e1</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">n1</span>) <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">e2</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">n2</span>) <span style="font-family: arial;">&rarr;</span> (<span class="id" type="var">AMult</span> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span>) <span style="font-family: arial;">&dArr;</span> (<span class="id" type="var">n1</span> * <span class="id" type="var">n2</span>)<br/>
<br/>
&nbsp;&nbsp;<span class="id" type="keyword">where</span> "e '<span style="font-family: arial;">&dArr;</span>' n" := (<span class="id" type="var">aevalR</span> <span class="id" type="var">e</span> <span class="id" type="var">n</span>) : <span class="id" type="var">type_scope</span>.<br/>

<br/>
<span class="id" type="keyword">Tactic Notation</span> "aevalR_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_ANum" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_APlus"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_AMinus" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_AMult" ].<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">aeval_iff_aevalR</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">a</span> <span class="id" type="var">n</span>,<br/>
&nbsp;&nbsp;(<span class="id" type="var">a</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">n</span>) <span style="font-family: arial;">&harr;</span> <span class="id" type="var">aeval</span> <span class="id" type="var">a</span> = <span class="id" type="var">n</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;<span class="id" type="tactic">split</span>.<br/>
&nbsp;<span class="id" type="var">Case</span> "<span style="font-family: arial;">&rarr;</span>".<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">intros</span> <span class="id" type="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">aevalR_cases</span> (<span class="id" type="tactic">induction</span> <span class="id" type="var">H</span>) <span class="id" type="var">SCase</span>; <span class="id" type="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "E_ANum".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "E_APlus".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHaevalR1</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHaevalR2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "E_AMinus".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHaevalR1</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHaevalR2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "E_AMult".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHaevalR1</span>. <span class="id" type="tactic">rewrite</span> <span class="id" type="var">IHaevalR2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;<span class="id" type="var">Case</span> "<span style="font-family: arial;">&larr;</span>".<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">generalize</span> <span class="id" type="tactic">dependent</span> <span class="id" type="var">n</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">aexp_cases</span> (<span class="id" type="tactic">induction</span> <span class="id" type="var">a</span>) <span class="id" type="var">SCase</span>; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">simpl</span>; <span class="id" type="tactic">intros</span>; <span class="id" type="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "ANum".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_ANum</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "APlus".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_APlus</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHa1</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHa2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "AMinus".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_AMinus</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHa1</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHa2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" type="var">SCase</span> "AMult".<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">E_AMult</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHa1</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="tactic">apply</span> <span class="id" type="var">IHa2</span>. <span class="id" type="tactic">reflexivity</span>.<br/>
<span class="id" type="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a name="lab289"></a><h4 class="section">Exercise: 3 stars  (bevalR)</h4>
 Write a relation <span class="inlinecode"><span class="id" type="var">bevalR</span></span> in the same style as
    <span class="inlinecode"><span class="id" type="var">aevalR</span></span>, and prove that it is equivalent to <span class="inlinecode"><span class="id" type="var">beval</span></span>.
</div>
<div class="code code-tight">

<br/>
<span class="comment">(*&nbsp;<br/>
Inductive&nbsp;bevalR:<br/>
<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span><br/>
*)</span><br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab291"></a><h1 class="section">Expressions With Variables</h1>

</div>
<div class="code code-space">

<br/>
</div>

<div class="doc">
<a name="lab292"></a><h2 class="section">Identifiers</h2>

</div>
<div class="code code-space">

<br/>
</div>

<div class="doc">
We define a new inductive datatype <span class="inlinecode"><span class="id" type="var">Id</span></span> so that we won't confuse
    identifiers and numbers. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">id</span> : <span class="id" type="keyword">Type</span> := <br/>
&nbsp;&nbsp;<span class="id" type="var">Id</span> : <span class="id" type="var">nat</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">id</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">beq_id</span> <span class="id" type="var">X1</span> <span class="id" type="var">X2</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> (<span class="id" type="var">X1</span>, <span class="id" type="var">X2</span>) <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">Id</span> <span class="id" type="var">n1</span>, <span class="id" type="var">Id</span> <span class="id" type="var">n2</span>) =&gt; <span class="id" type="var">beq_nat</span> <span class="id" type="var">n1</span> <span class="id" type="var">n2</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab297"></a><h2 class="section">States</h2>

<div class="paragraph"> </div>

 A <i>state</i> represents the current values of all the variables at
    some point in the execution of a program.  For simplicity (to avoid dealing with partial functions), we
    let the state be defined for <i>all</i> variables, even though any
    given program is only going to mention a finite number of them. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">state</span> := <span class="id" type="var">id</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">nat</span>.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">empty_state</span> : <span class="id" type="var">state</span> := <br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">_</span> =&gt; 0.<br/>

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">update</span> (<span class="id" type="var">st</span> : <span class="id" type="var">state</span>) (<span class="id" type="var">X</span>:<span class="id" type="var">id</span>) (<span class="id" type="var">n</span> : <span class="id" type="var">nat</span>) : <span class="id" type="var">state</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">fun</span> <span class="id" type="var">X'</span> =&gt; <span class="id" type="keyword">if</span> <span class="id" type="var">beq_id</span> <span class="id" type="var">X</span> <span class="id" type="var">X'</span> <span class="id" type="keyword">then</span> <span class="id" type="var">n</span> <span class="id" type="keyword">else</span> <span class="id" type="var">st</span> <span class="id" type="var">X'</span>.<br/>

<br/>
</div>

<div class="doc">
For proofs involving states, we'll need several simple properties
    of <span class="inlinecode"><span class="id" type="var">update</span></span>. 
<div class="paragraph"> </div>

<a name="lab298"></a><h4 class="section">Exercise: 1 star (update_eq)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">update_eq</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">n</span> <span class="id" type="var">X</span> <span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;(<span class="id" type="var">update</span> <span class="id" type="var">st</span> <span class="id" type="var">X</span> <span class="id" type="var">n</span>) <span class="id" type="var">X</span> = <span class="id" type="var">n</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab299"></a><h4 class="section">Exercise: 1 star (update_neq)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">update_neq</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">V2</span> <span class="id" type="var">V1</span> <span class="id" type="var">n</span> <span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">beq_id</span> <span class="id" type="var">V2</span> <span class="id" type="var">V1</span> = <span class="id" type="var">false</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;(<span class="id" type="var">update</span> <span class="id" type="var">st</span> <span class="id" type="var">V2</span> <span class="id" type="var">n</span>) <span class="id" type="var">V1</span> = (<span class="id" type="var">st</span> <span class="id" type="var">V1</span>).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab300"></a><h4 class="section">Exercise: 1 star (update_example)</h4>
 Before starting to play with tactics, make sure you understand
    exactly what the theorem is saying! 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">update_example</span> : <span style="font-family: arial;">&forall;</span>(<span class="id" type="var">n</span>:<span class="id" type="var">nat</span>), <br/>
&nbsp;&nbsp;(<span class="id" type="var">update</span> <span class="id" type="var">empty_state</span> (<span class="id" type="var">Id</span> 2) <span class="id" type="var">n</span>) (<span class="id" type="var">Id</span> 3) = 0.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab301"></a><h4 class="section">Exercise: 1 star, recommended (update_shadow)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">update_shadow</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">x1</span> <span class="id" type="var">x2</span> <span class="id" type="var">k1</span> <span class="id" type="var">k2</span> (<span class="id" type="var">f</span> : <span class="id" type="var">state</span>),<br/>
&nbsp;&nbsp;&nbsp;(<span class="id" type="var">update</span>  (<span class="id" type="var">update</span> <span class="id" type="var">f</span> <span class="id" type="var">k2</span> <span class="id" type="var">x1</span>) <span class="id" type="var">k2</span> <span class="id" type="var">x2</span>) <span class="id" type="var">k1</span> = (<span class="id" type="var">update</span> <span class="id" type="var">f</span> <span class="id" type="var">k2</span> <span class="id" type="var">x2</span>) <span class="id" type="var">k1</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab302"></a><h4 class="section">Exercise: 2 stars (update_same)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">update_same</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">x1</span> <span class="id" type="var">k1</span> <span class="id" type="var">k2</span> (<span class="id" type="var">f</span> : <span class="id" type="var">state</span>),<br/>
&nbsp;&nbsp;<span class="id" type="var">f</span> <span class="id" type="var">k1</span> = <span class="id" type="var">x1</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;(<span class="id" type="var">update</span> <span class="id" type="var">f</span> <span class="id" type="var">k1</span> <span class="id" type="var">x1</span>) <span class="id" type="var">k2</span> = <span class="id" type="var">f</span> <span class="id" type="var">k2</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab303"></a><h4 class="section">Exercise: 3 stars (update_permute)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">update_permute</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">x1</span> <span class="id" type="var">x2</span> <span class="id" type="var">k1</span> <span class="id" type="var">k2</span> <span class="id" type="var">k3</span> <span class="id" type="var">f</span>,<br/>
&nbsp;&nbsp;<span class="id" type="var">beq_id</span> <span class="id" type="var">k2</span> <span class="id" type="var">k1</span> = <span class="id" type="var">false</span> <span style="font-family: arial;">&rarr;</span> <br/>
&nbsp;&nbsp;(<span class="id" type="var">update</span> (<span class="id" type="var">update</span> <span class="id" type="var">f</span> <span class="id" type="var">k2</span> <span class="id" type="var">x1</span>) <span class="id" type="var">k1</span> <span class="id" type="var">x2</span>) <span class="id" type="var">k3</span> = (<span class="id" type="var">update</span> (<span class="id" type="var">update</span> <span class="id" type="var">f</span> <span class="id" type="var">k1</span> <span class="id" type="var">x2</span>) <span class="id" type="var">k2</span> <span class="id" type="var">x1</span>) <span class="id" type="var">k3</span>.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab304"></a><h2 class="section">Syntax</h2>

<div class="paragraph"> </div>

 We can add variables to the arithmetic expressions we had before by
    simply adding one more constructor: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">aexp</span> : <span class="id" type="keyword">Type</span> := <br/>
&nbsp;&nbsp;| <span class="id" type="var">ANum</span> : <span class="id" type="var">nat</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">AId</span> : <span class="id" type="var">id</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span>                <span class="comment">(*&nbsp;&lt;-----&nbsp;NEW&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">APlus</span> : <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">AMinus</span> : <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">AMult</span> : <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span>.<br/>

<br/>
<span class="id" type="keyword">Tactic Notation</span> "aexp_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "ANum" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "AId" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "APlus"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "AMinus" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "AMult" ].<br/>

<br/>
</div>

<div class="doc">
Defining a few variable names as notational shorthands will make
    examples easier to read: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">X</span> : <span class="id" type="var">id</span> := <span class="id" type="var">Id</span> 0.<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">Y</span> : <span class="id" type="var">id</span> := <span class="id" type="var">Id</span> 1.<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">Z</span> : <span class="id" type="var">id</span> := <span class="id" type="var">Id</span> 2.<br/>

<br/>
</div>

<div class="doc">
(This convention for naming program variables (<span class="inlinecode"><span class="id" type="var">X</span></span>, <span class="inlinecode"><span class="id" type="var">Y</span></span>,
    <span class="inlinecode"><span class="id" type="var">Z</span></span>) clashes a bit with our earlier use of uppercase letters for
    types.  Since we're not using polymorphism heavily in this part of
    the course, this overloading should not cause confusion.) 
<div class="paragraph"> </div>

 The definition of <span class="inlinecode"><span class="id" type="var">bexp</span></span>s is the same as before (using the new
    <span class="inlinecode"><span class="id" type="var">aexp</span></span>s): 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">bexp</span> : <span class="id" type="keyword">Type</span> := <br/>
&nbsp;&nbsp;| <span class="id" type="var">BTrue</span> : <span class="id" type="var">bexp</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BFalse</span> : <span class="id" type="var">bexp</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BEq</span> : <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">bexp</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BLe</span> : <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">bexp</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BNot</span> : <span class="id" type="var">bexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">bexp</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BAnd</span> : <span class="id" type="var">bexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">bexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">bexp</span>.<br/>

<br/>
<span class="id" type="keyword">Tactic Notation</span> "bexp_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "BTrue" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "BFalse" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "BEq"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "BLe" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "BNot" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "BAnd" ].<br/>

<br/>
</div>

<div class="doc">
<a name="lab305"></a><h2 class="section">Evaluation</h2>

<div class="paragraph"> </div>

 The arith and boolean evaluators can be extended to handle
    variables in the obvious way: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">aeval</span> (<span class="id" type="var">st</span> : <span class="id" type="var">state</span>) (<span class="id" type="var">e</span> : <span class="id" type="var">aexp</span>) : <span class="id" type="var">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">e</span> <span class="id" type="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">ANum</span> <span class="id" type="var">n</span> =&gt; <span class="id" type="var">n</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">AId</span> <span class="id" type="var">X</span> =&gt; <span class="id" type="var">st</span> <span class="id" type="var">X</span>                                        <span class="comment">(*&nbsp;&lt;-----&nbsp;NEW&nbsp;*)</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">APlus</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span> =&gt; (<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a1</span>) + (<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">AMinus</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>  =&gt; (<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a1</span>) - (<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">AMult</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span> =&gt; (<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a1</span>) * (<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">beval</span> (<span class="id" type="var">st</span> : <span class="id" type="var">state</span>) (<span class="id" type="var">e</span> : <span class="id" type="var">bexp</span>) : <span class="id" type="var">bool</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">e</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;| <span class="id" type="var">BTrue</span>       =&gt; <span class="id" type="var">true</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BFalse</span>      =&gt; <span class="id" type="var">false</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">BEq</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>   =&gt; <span class="id" type="var">beq_nat</span> (<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a1</span>) (<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">BLe</span> <span class="id" type="var">a1</span> <span class="id" type="var">a2</span>   =&gt; <span class="id" type="var">ble_nat</span> (<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a1</span>) (<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a2</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">BNot</span> <span class="id" type="var">b1</span>     =&gt; <span class="id" type="var">negb</span> (<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">BAnd</span> <span class="id" type="var">b1</span> <span class="id" type="var">b2</span>  =&gt; <span class="id" type="var">andb</span> (<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span>) (<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b2</span>)<br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">aexp1</span> : <br/>
&nbsp;&nbsp;<span class="id" type="var">aeval</span> (<span class="id" type="var">update</span> <span class="id" type="var">empty_state</span> <span class="id" type="var">X</span> 5) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">APlus</span> (<span class="id" type="var">ANum</span> 3) (<span class="id" type="var">AMult</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 2))) <br/>
&nbsp;&nbsp;= 13.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
<span class="id" type="keyword">Example</span> <span class="id" type="var">bexp1</span> :<br/>
&nbsp;&nbsp;<span class="id" type="var">beval</span> (<span class="id" type="var">update</span> <span class="id" type="var">empty_state</span> <span class="id" type="var">X</span> 5) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">BAnd</span> <span class="id" type="var">BTrue</span> (<span class="id" type="var">BNot</span> (<span class="id" type="var">BLe</span> (<span class="id" type="var">AId</span> <span class="id" type="var">X</span>) (<span class="id" type="var">ANum</span> 4))))<br/>
&nbsp;&nbsp;= <span class="id" type="var">true</span>.<br/>
<span class="id" type="keyword">Proof</span>. <span class="id" type="tactic">reflexivity</span>. <span class="id" type="keyword">Qed</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab306"></a><h1 class="section">Commands</h1>

<div class="paragraph"> </div>

 Now we are ready define the syntax and behavior of Imp
    <i>commands</i> (or <i>statements</i>). 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab307"></a><h2 class="section">Syntax</h2>

</div>
<div class="code code-space">

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">com</span> : <span class="id" type="keyword">Type</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">CSkip</span> : <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CAss</span> : <span class="id" type="var">id</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">aexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CSeq</span> : <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CIf</span> : <span class="id" type="var">bexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">CWhile</span> : <span class="id" type="var">bexp</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">com</span>.<br/>

<br/>
<span class="id" type="keyword">Tactic Notation</span> "com_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "SKIP" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "::=" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> ";"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "IFB" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "WHILE" ].<br/>

<br/>
</div>

<div class="doc">
As usual, we can use a few <span class="inlinecode"><span class="id" type="keyword">Notation</span></span> declarations to make things
    more readable.  We need to be a bit careful to avoid conflicts
    with Coq's built-in notations, so we'll keep this light &mdash; in
    particular, we won't introduce any notations for <span class="inlinecode"><span class="id" type="var">aexps</span></span> and
    <span class="inlinecode"><span class="id" type="var">bexps</span></span> to avoid confusion with the numerical and boolean
    operators we've already defined.  We use the keyword <span class="inlinecode"><span class="id" type="var">IFB</span></span> for
    conditionals instead of <span class="inlinecode"><span class="id" type="var">IF</span></span>, for similar reasons. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Notation</span> "'SKIP'" := <br/>
&nbsp;&nbsp;<span class="id" type="var">CSkip</span>.<br/>
<span class="id" type="keyword">Notation</span> "X '::=' a" := <br/>
&nbsp;&nbsp;(<span class="id" type="var">CAss</span> <span class="id" type="var">X</span> <span class="id" type="var">a</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 60).<br/>
<span class="id" type="keyword">Notation</span> "c1 ; c2" := <br/>
&nbsp;&nbsp;(<span class="id" type="var">CSeq</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>
<span class="id" type="keyword">Notation</span> "'WHILE' b 'DO' c 'END'" := <br/>
&nbsp;&nbsp;(<span class="id" type="var">CWhile</span> <span class="id" type="var">b</span> <span class="id" type="var">c</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>
<span class="id" type="keyword">Notation</span> "'IFB' e1 'THEN' e2 'ELSE' e3 'FI'" := <br/>
&nbsp;&nbsp;(<span class="id" type="var">CIf</span> <span class="id" type="var">e1</span> <span class="id" type="var">e2</span> <span class="id" type="var">e3</span>) (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 80, <span class="id" type="var">right</span> <span class="id" type="var">associativity</span>).<br/>

<br/>
</div>

<div class="doc">
For example, here is the factorial function again, written as a
    formal definition to Coq: 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">fact_in_coq</span> : <span class="id" type="var">com</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="var">Z</span> ::= <span class="id" type="var">AId</span> <span class="id" type="var">X</span>;<br/>
&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">ANum</span> 1;<br/>
&nbsp;&nbsp;<span class="id" type="var">WHILE</span> <span class="id" type="var">BNot</span> (<span class="id" type="var">BEq</span> (<span class="id" type="var">AId</span> <span class="id" type="var">Z</span>) (<span class="id" type="var">ANum</span> 0)) <span class="id" type="var">DO</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Y</span> ::= <span class="id" type="var">AMult</span> (<span class="id" type="var">AId</span> <span class="id" type="var">Y</span>) (<span class="id" type="var">AId</span> <span class="id" type="var">Z</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">Z</span> ::= <span class="id" type="var">AMinus</span> (<span class="id" type="var">AId</span> <span class="id" type="var">Z</span>) (<span class="id" type="var">ANum</span> 1)<br/>
&nbsp;&nbsp;<span class="id" type="var">END</span>.<br/>

<br/>
</div>

<div class="doc">
<a name="lab309"></a><h1 class="section">Evaluation</h1>

<div class="paragraph"> </div>

 Next we need to define what it means to evaluate an Imp command.
    The fact that <span class="inlinecode"><span class="id" type="var">WHILE</span></span> loops don't necessarily terminate makes defining
    an evaluation function tricky ... 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab310"></a><h2 class="section">Evaluation Function (Failed Attempt)</h2>

<div class="paragraph"> </div>

 Here's an attempt at defining an evaluation function for commands,
    omitting the <span class="inlinecode"><span class="id" type="var">WHILE</span></span> case. 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Fixpoint</span> <span class="id" type="var">ceval_fun_no_while</span> (<span class="id" type="var">st</span> : <span class="id" type="var">state</span>) (<span class="id" type="var">c</span> : <span class="id" type="var">com</span>) : <span class="id" type="var">state</span> :=<br/>
&nbsp;&nbsp;<span class="id" type="keyword">match</span> <span class="id" type="var">c</span> <span class="id" type="keyword">with</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">SKIP</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">l</span> ::= <span class="id" type="var">a1</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">update</span> <span class="id" type="var">st</span> <span class="id" type="var">l</span> (<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a1</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">c1</span> ; <span class="id" type="var">c2</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">let</span> <span class="id" type="var">st'</span> := <span class="id" type="var">ceval_fun_no_while</span> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <span class="id" type="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">ceval_fun_no_while</span> <span class="id" type="var">st'</span> <span class="id" type="var">c2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">IFB</span> <span class="id" type="var">b</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">if</span> (<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b</span>) <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">then</span> <span class="id" type="var">ceval_fun_no_while</span> <span class="id" type="var">st</span> <span class="id" type="var">c1</span> <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="keyword">else</span> <span class="id" type="var">ceval_fun_no_while</span> <span class="id" type="var">st</span> <span class="id" type="var">c2</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span> =&gt; <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">st</span>  <span class="comment">(*&nbsp;bogus&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" type="keyword">end</span>.<br/>

<br/>
</div>

<div class="doc">
In a traditional functional programming language like ML or
    Haskell we could write the WHILE case as follows:
<pre>
Fixpoint ceval_fun (st : state) (c : com) : state :=
  match c with 
    ...
    | WHILE b1 DO c1 END =&gt; 
        if (beval st b1) 
          then ceval_fun st (c1; WHILE b1 DO c1 END)
          else st 
  end.
</pre>
    Coq doesn't accept such a definition (<span class="inlinecode"><span class="id" type="var">Error</span>:</span> <span class="inlinecode"><span class="id" type="var">Cannot</span></span> <span class="inlinecode"><span class="id" type="var">guess</span></span>
    <span class="inlinecode"><span class="id" type="var">decreasing</span></span> <span class="inlinecode"><span class="id" type="var">argument</span></span> <span class="inlinecode"><span class="id" type="var">of</span></span> <span class="inlinecode"><span class="id" type="var">fix</span></span>) because the function we want to
    define is not guaranteed to terminate. Indeed, the full version of
    the <span class="inlinecode"><span class="id" type="var">ceval_fun</span></span> function applied to the <span class="inlinecode"><span class="id" type="var">loop</span></span> program above would
    never terminate. Since Coq is not just a functional programming
    language, but also a consistent logic, any potentially
    non-terminating function needs to be rejected. Here is an
    invalid(!) Coq program showing what would go wrong if Coq allowed
    non-terminating recursive functions:
<pre>
     Fixpoint loop_false (n : nat) : False := loop_false n.
</pre>
    That is, propositions like <span class="inlinecode"><span class="id" type="var">False</span></span> would become
    provable (e.g. <span class="inlinecode"><span class="id" type="var">loop_false</span></span> <span class="inlinecode">0</span> would be a proof of <span class="inlinecode"><span class="id" type="var">False</span></span>), which
    would be a disaster for Coq's logical consistency.

<div class="paragraph"> </div>

    Thus, because it doesn't terminate on all inputs, the full version
    of <span class="inlinecode"><span class="id" type="var">ceval_fun</span></span> cannot be written in Coq &mdash; at least not without
    additional tricks, which make everything much more complicated
    (see chapter <span class="inlinecode"><span class="id" type="var">ImpCEvalFun</span></span> if curious). 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
<a name="lab311"></a><h2 class="section">Evaluation as a Relation</h2>

<div class="paragraph"> </div>

 Here's a better way: we define <span class="inlinecode"><span class="id" type="var">ceval</span></span> as a <i>relation</i> rather than
    a <i>function</i> &mdash; i.e., we define it in <span class="inlinecode"><span class="id" type="keyword">Prop</span></span> instead of <span class="inlinecode"><span class="id" type="keyword">Type</span></span>, as
    we did for <span class="inlinecode"><span class="id" type="var">aevalR</span></span> and <span class="inlinecode"><span class="id" type="var">bevalR</span></span> above. 
</div>
<div class="code code-tight">

<br/>
</div>

<div class="doc">
We'll use the notation <span class="inlinecode"><span class="id" type="var">c</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> for our <span class="inlinecode"><span class="id" type="var">ceval</span></span> relation,
    that is <span class="inlinecode"><span class="id" type="var">c</span></span> <span class="inlinecode">/</span> <span class="inlinecode"><span class="id" type="var">st</span></span> <span class="inlinecode"><span style="font-family: arial;">&dArr;</span></span> <span class="inlinecode"><span class="id" type="var">st'</span></span> means that executing program <span class="inlinecode"><span class="id" type="var">c</span></span> in a
    starting state <span class="inlinecode"><span class="id" type="var">st</span></span> results in an ending state <span class="inlinecode"><span class="id" type="var">st'</span></span>.  This can be
    pronounced "<span class="inlinecode"><span class="id" type="var">c</span></span> takes state <span class="inlinecode"><span class="id" type="var">st</span></span> to <span class="inlinecode"><span class="id" type="var">st'</span></span>". 
<center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">&nbsp;&nbsp;</td>
  <td class="infrulenamecol" rowspan="3">
    (E_Skip) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">SKIP&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">aeval&nbsp;st&nbsp;a1&nbsp;=&nbsp;n</td>
  <td class="infrulenamecol" rowspan="3">
    (E_Ass) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">X&nbsp;:=&nbsp;a1&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;(update&nbsp;st&nbsp;X&nbsp;n)</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">c1&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st'</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">c2&nbsp;/&nbsp;st'&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st''</td>
  <td class="infrulenamecol" rowspan="3">
    (E_Seq) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">c1;c2&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st''</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">beval&nbsp;st&nbsp;b1&nbsp;=&nbsp;true</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">c1&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st'</td>
  <td class="infrulenamecol" rowspan="3">
    (E_IfTrue) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">IF&nbsp;b1&nbsp;THEN&nbsp;c1&nbsp;ELSE&nbsp;c2&nbsp;FI&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st'</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">beval&nbsp;st&nbsp;b1&nbsp;=&nbsp;false</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">c2&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st'</td>
  <td class="infrulenamecol" rowspan="3">
    (E_IfFalse) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">IF&nbsp;b1&nbsp;THEN&nbsp;c1&nbsp;ELSE&nbsp;c2&nbsp;FI&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st'</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">beval&nbsp;st&nbsp;b1&nbsp;=&nbsp;false</td>
  <td class="infrulenamecol" rowspan="3">
    (E_WhileEnd) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">WHILE&nbsp;b1&nbsp;DO&nbsp;c1&nbsp;END&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st</td>
  <td></td>
</td>
</table></center><center><table class="infrule">
<tr class="infruleassumption">
  <td class="infrule">beval&nbsp;st&nbsp;b1&nbsp;=&nbsp;true</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">c1&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st'</td>
  <td></td>
</td>
<tr class="infruleassumption">
  <td class="infrule">WHILE&nbsp;b1&nbsp;DO&nbsp;c1&nbsp;END&nbsp;/&nbsp;st'&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st''</td>
  <td class="infrulenamecol" rowspan="3">
    (E_WhileLoop) &nbsp;
  </td></tr>
<tr class="infrulemiddle">
  <td class="infrule"><hr /></td>
</tr>
<tr class="infruleassumption">
  <td class="infrule">WHILE&nbsp;b1&nbsp;DO&nbsp;c1&nbsp;END&nbsp;/&nbsp;st&nbsp;<span style="font-family: arial;">&dArr;</span>&nbsp;st''</td>
  <td></td>
</td>
</table></center>
<div class="paragraph"> </div>

 Here is the formal definition.  (Make sure you understand
    how it corresponds to the inference rules.) 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Reserved Notation</span> "c1 '/' st '<span style="font-family: arial;">&dArr;</span>' st'" (<span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 40, <span class="id" type="var">st</span> <span class="id" type="tactic">at</span> <span class="id" type="var">level</span> 39).<br/>

<br/>
<span class="id" type="keyword">Inductive</span> <span class="id" type="var">ceval</span> : <span class="id" type="var">com</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">state</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="var">state</span> <span style="font-family: arial;">&rarr;</span> <span class="id" type="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <span class="id" type="var">E_Skip</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">SKIP</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_Ass</span>  : <span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span> <span class="id" type="var">a1</span> <span class="id" type="var">n</span> <span class="id" type="var">X</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">aeval</span> <span class="id" type="var">st</span> <span class="id" type="var">a1</span> = <span class="id" type="var">n</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">X</span> ::= <span class="id" type="var">a1</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> (<span class="id" type="var">update</span> <span class="id" type="var">st</span> <span class="id" type="var">X</span> <span class="id" type="var">n</span>)<br/>
&nbsp;&nbsp;| <span class="id" type="var">E_Seq</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">c1</span> <span class="id" type="var">c2</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">st''</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span> / <span class="id" type="var">st</span>  <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c2</span> / <span class="id" type="var">st'</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st''</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">c1</span> ; <span class="id" type="var">c2</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st''</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_IfTrue</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">b1</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="var">true</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">IFB</span> <span class="id" type="var">b1</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_IfFalse</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">b1</span> <span class="id" type="var">c1</span> <span class="id" type="var">c2</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="var">false</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c2</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">IFB</span> <span class="id" type="var">b1</span> <span class="id" type="var">THEN</span> <span class="id" type="var">c1</span> <span class="id" type="var">ELSE</span> <span class="id" type="var">c2</span> <span class="id" type="var">FI</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_WhileEnd</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">b1</span> <span class="id" type="var">st</span> <span class="id" type="var">c1</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="var">false</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st</span><br/>
&nbsp;&nbsp;| <span class="id" type="var">E_WhileLoop</span> : <span style="font-family: arial;">&forall;</span><span class="id" type="var">st</span> <span class="id" type="var">st'</span> <span class="id" type="var">st''</span> <span class="id" type="var">b1</span> <span class="id" type="var">c1</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">beval</span> <span class="id" type="var">st</span> <span class="id" type="var">b1</span> = <span class="id" type="var">true</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">c1</span> / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st'</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) / <span class="id" type="var">st'</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st''</span> <span style="font-family: arial;">&rarr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">WHILE</span> <span class="id" type="var">b1</span> <span class="id" type="var">DO</span> <span class="id" type="var">c1</span> <span class="id" type="var">END</span>) / <span class="id" type="var">st</span> <span style="font-family: arial;">&dArr;</span> <span class="id" type="var">st''</span><br/>
<br/>
&nbsp;&nbsp;<span class="id" type="keyword">where</span> "c1 '/' st '<span style="font-family: arial;">&dArr;</span>' st'" := (<span class="id" type="var">ceval</span> <span class="id" type="var">c1</span> <span class="id" type="var">st</span> <span class="id" type="var">st'</span>).<br/>

<br/>
<span class="id" type="keyword">Tactic Notation</span> "ceval_cases" <span class="id" type="var">tactic</span>(<span class="id" type="var">first</span>) <span class="id" type="var">ident</span>(<span class="id" type="var">c</span>) :=<br/>
&nbsp;&nbsp;<span class="id" type="var">first</span>;<br/>
&nbsp;&nbsp;[ <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_Skip" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_Ass" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_Seq"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_IfTrue" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_IfFalse"<br/>
&nbsp;&nbsp;| <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_WhileEnd" | <span class="id" type="var">Case_aux</span> <span class="id" type="var">c</span> "E_WhileLoop" ].<br/>

<br/>
</div>

<div class="doc">
<a name="lab312"></a><h4 class="section">Exercise: 2 stars (ceval_example2)</h4>

</div>
<div class="code code-space">
<span class="id" type="keyword">Example</span> <span class="id" type="var">ceval_example2</span>:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">X</span> ::= <span class="id" type="var">ANum</span> 0; <span class="id" type="var">Y</span> ::= <span class="id" type="var">ANum</span> 1; <span class="id" type="var">Z</span> ::= <span class="id" type="var">ANum</span> 2) / <span class="id" type="var">empty_state</span> <span style="font-family: arial;">&dArr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" type="var">update</span> (<span class="id" type="var">update</span> (<span class="id" type="var">update</span> <span class="id" type="var">empty_state</span> <span class="id" type="var">X</span> 0) <span class="id" type="var">Y</span> 1) <span class="id" type="var">Z</span> 2).<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

<a name="lab313"></a><h4 class="section">Exercise: 3 stars, optional (pup_to_n)</h4>
 Write an Imp program that sums the numbers from <span class="inlinecode">1</span> to
   <span class="inlinecode"><span class="id" type="var">X</span></span> (inclusive: <span class="inlinecode">1</span> <span class="inlinecode">+</span> <span class="inlinecode">2</span> <span class="inlinecode">+</span> <span class="inlinecode">...</span> <span class="inlinecode">+</span> <span class="inlinecode"><span class="id" type="var">X</span></span>) in the variable <span class="inlinecode"><span class="id" type="var">Y</span></span>.
   Prove that this program executes as intended for X = 2
   (this latter part is trickier than you might expect). 
</div>
<div class="code code-tight">

<br/>
<span class="id" type="keyword">Definition</span> <span class="id" type="var">pup_to_n</span> : <span class="id" type="var">com</span> := <br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">admit</span>.<br/>

<br/>
<span class="id" type="keyword">Theorem</span> <span class="id" type="var">pup_to_2_ceval</span> : <br/>
&nbsp;&nbsp;<span class="id" type="var">pup_to_n</span> / (<span class="id" type="var">update</span> <span class="id" type="var">empty_state</span> <span class="id" type="var">X</span> 2) <span style="font-family: arial;">&dArr;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">update</span> (<span class="id" type="var">update</span> (<span class="id" type="var">update</span> (<span class="id" type="var">update</span> (<span class="id" type="var">update</span> (<span class="id" type="var">update</span> <span class="id" type="var">empty_state</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" type="var">X</span> 2) <span class="id" type="var">Y</span> 0) <span class="id" type="var">Y</span> 2) <span class="id" type="var">X</span> 1) <span class="id" type="var">Y</span> 3) <span class="id" type="var">X</span> 0.<br/>
<span class="id" type="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" type="var">Admitted</span>.<br/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
</div>
<div class="code code-tight">

<br/>

<br/>
</div>
</div>

<div id="footer">
<hr/><a href="coqindex.html">Index</a><hr/>This page has been generated by <a href="http://www.lix.polytechnique.fr/coq/">coqdoc</a>
</div>

</div>

</body>
</html>